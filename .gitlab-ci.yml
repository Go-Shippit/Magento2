# Stages
stages:
  - build
  - lint
  - code-style


build:
  type: build
  artifacts:
    untracked: true
    expire_in: 7 days
    paths:
      - ./
  before_script:
    ##
    ## Run ssh-agent (inside the build environment)
    ##
    - eval $(ssh-agent -s)

    ##
    ## Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
    ## We're using tr to fix line endings which makes ed25519 keys work
    ## without extra base64 encoding.
    ## https://gitlab.com/gitlab-examples/ssh-private-key/issues/1#note_48526556
    ##
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null

    ##
    ## Create the SSH directory and give it the right permissions
    ##
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    ##
    ## Add the SSH known hosts
    ##
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

    ##
    ## Add composer authentication keys
    ##
    - mkdir -p ~/.composer
    - echo "$COMPOSER_AUTH" > ~/.composer/auth.json

  script:
    - php --version
    - composer --version
    - composer install --verbose --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader


.php-linter: &php-linter
  stage: lint
  dependencies:
    - build
  script:
    - php --version
    - parallel-lint --version
    - parallel-lint --exclude ./vendor ./

php-5.5-linter:
  <<: *php-linter
  image: mamis/php-build:5.5

php-5.6-linter:
  <<: *php-linter
  image: mamis/php-build:5.6

php-7.0-linter:
  <<: *php-linter
  image: mamis/php-build:7.0

php-7.1-linter:
  <<: *php-linter
  image: mamis/php-build:7.1

php-7.2-linter:
  <<: *php-linter
  image: mamis/php-build:7.2

php-depreciations-linter:
  stage: lint
  image: mamis/php-build:7.2
  dependencies:
    - build
  script:
    - php --version
    - phpcf --version
    - phpcf --target=7.2 ./

phpcs-psr2:
  stage: code-style
  image: mamis/php-build:7.2
  dependencies:
    - build
  script:
    - php -v
    - phpcs --version
    - phpcs --colors --standard=PSR2 --report=full,summary,gitblame .
  allow_failure: true
